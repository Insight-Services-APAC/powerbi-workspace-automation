

stages:
- stage: Development

  variables:
    - template: variables.yml

  jobs:
  - job: Infrastructure
    condition: false
    displayName: Infrastructure Deploy
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: AzureCLI@2
      displayName: AZ CLI - Bicep Deploy
      inputs:
        azureSubscription: ${{ variables.azSubscription }}
        scriptType: 'ps'
        workingDirectory: $(Build.SourcesDirectory)\Producer
        scriptPath: $(Build.SourcesDirectory)\Producer\scripts\deploy-infra.ps1
        arguments:
          -ClientPrefix ${{ variables.clientPrefix }} `
          -Env ${{ variables.env }} `
          -AadObjectId ${{ variables.aadObjectId }}

  - job: FunctionApp
    condition: true
    displayName: FunctionApp Build and Deploy
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: AzureCLI@2
      displayName: AZ CLI - Function App Build and Deploy
      inputs:
        azureSubscription: ${{ variables.azSubscription }}
        scriptType: 'ps'
        workingDirectory: $(Build.SourcesDirectory)\Producer
        scriptPath: $(Build.SourcesDirectory)\Producer\scripts\deploy-func.ps1
        arguments:
          -ResourceGroup ${{ variables.rg }} `
          -FunctionApp ${{ variables.func }}
  
  - job: APIManagement
    condition: true
    displayName: APIM Deploy
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: AzureCLI@2
      displayName: AZ CLI - APIM ARM Linked Template Deployment
      inputs:
        azureSubscription: ${{ variables.azSubscription }}
        scriptType: 'pscore'
        workingDirectory: $(Build.SourcesDirectory)\Producer
        scriptPath: $(Build.SourcesDirectory)\Producer\scripts\deploy-apim.ps1
        arguments:
          -ApimName ${{ variables.apim }} `
          -ResourceGroup ${{ variables.rg }} `
          -SourcePath $(Build.SourcesDirectory)\Producer\apim `
          -StorageAccount ${{ variables.storage }} `
          -FunctionName ${{ variables.func }}